# Toy Trip Generator

AI-powered trip itinerary and gallery image generator for toy travel adventures.

## Overview

Generates realistic trip itineraries with famous destinations and AI-generated gallery images featuring toys at iconic landmarks around the world. Reads toy profiles from `toy_profiles.json` (no running services required).

## Features

- Reads toys from `toy_profiles.json` (generated by toy-profile-generator)
- Generates 1-3 random trips per toy
- Creates itineraries with famous destinations (Paris, Rome, Machu Picchu, etc.)
- AI-generated gallery images (3-8 per trip) featuring toy at landmarks
- Uses toy avatar from `toy-images/` for consistent character appearance
- Incremental saving (resume if interrupted)
- Outputs `trips.json` and `trip-images/` folder

## Prerequisites

- Python 3.12+
- Azure OpenAI access (GPT-5 and gpt-image-1 models)
- Generated toy profiles (`toy_profiles.json` and `toy-images/`)
- Azure credentials configured (`az login` or environment variables)

## Setup

### 1. Configure Environment

Copy `.env.example` to `.env` and configure:

```bash
# Azure OpenAI
AZURE_OPENAI_ENDPOINT=https://your-resource.cognitiveservices.azure.com
GPT_DEPLOYMENT_NAME=gpt-5
IMAGE_DEPLOYMENT_NAME=gpt-image-1

# Generation settings
MIN_TRIPS_PER_TOY=1
MAX_TRIPS_PER_TOY=3
MIN_IMAGES_PER_TRIP=3
MAX_IMAGES_PER_TRIP=8
```

### 2. Install Dependencies

```bash
uv sync
```

### 3. Ensure Prerequisites

- Run `toy-profile-generator` first to create `toy_profiles.json` and `toy-images/`

## Usage

```bash
# Generate trips for all toys
uv run python main.py
```

The script will:
1. Fetch all toys from the toy service (with database-generated UUIDs)
2. Skip toys that already have trips (incremental)
3. Generate famous destinations list (30+ locations)
4. For each toy:
   - Create 1-3 random trips
   - Generate itinerary with 2-5 legs
   - Fetch toy avatar from service
   - Create 3-8 gallery images per trip using avatar
5. Save results to `../trips.json` and `../trip-images/`

## Output Format

### trips.json

```json
[
  {
    "trip_id": "uuid",
    "toy_id": "uuid",
    "toy_name": "Captain Whiskers",
    "title": "Captain Whiskers' European Adventure",
    "description": "An epic journey through...",
    "legs": [
      {
        "leg_number": 1,
        "location_name": "Paris",
        "country_code": "FR"
      }
    ],
    "gallery_images": [
      {
        "image_id": "uuid",
        "leg_number": 1,
        "blob_name": "uuid.jpg",
        "landmark": "Eiffel Tower",
        "caption": "Captain Whiskers at Eiffel Tower"
      }
    ]
  }
]
```

### trip-images/

Directory containing GUID-named JPEG files (512x512, optimized).

## Architecture

### AI Models

- **GPT-5**: Generates destinations, itineraries, and image prompts
- **gpt-image-1**: Creates gallery images with image editing (toy avatar â†’ landmark scene)

### Image Generation

Uses Azure OpenAI image editing to place toy character into landmark scenes:
1. Fetch toy avatar from service
2. Generate scene prompts (various angles, distances, times of day)
3. Use image editing to composite toy into scenes
4. Resize to 512x512 and optimize

### Incremental Generation

- Loads existing `trips.json` on start
- Skips toys that already have trips
- Saves after each trip (safe to interrupt)
- Validates image files exist

## Error Handling

- **No toys found**: Run toy-profile-generator and import first
- **No avatar**: Skips gallery generation, creates trip metadata only
- **Auth token expired**: Run `get_auth_token.py` again
- **API errors**: Retries with backoff, continues with next toy
- **Interrupt**: Saves partial results, resume by re-running

## Performance

- ~30-60 seconds per trip (depends on image count)
- ~2-5 minutes per toy (1-3 trips)
- Can take 1-2 hours for 50 toys
- Progress displayed in real-time
- Incremental saves allow resumption

## Troubleshooting

### "No toys found"
Ensure toy service is running and has registered toys:
```bash
cd ../../src/services/toy
uv run uvicorn main:app --reload --port 8001
```

Check toys are imported:
```bash
cd ../../../tools/data
uv run python check-toy-profiles.py
```

### "Auth token expired"
Refresh token:
```bash
cd ../../identity
uv run python get_auth_token.py
```

### "Failed to fetch avatar"
Verify toy has avatar:
```bash
uv run python tools/data/check-toy-profiles.py
```

### Image generation fails
- Check Azure OpenAI quota/limits
- Verify `gpt-image-1` deployment exists
- Check network connectivity

## Integration

Generated trips can be imported into trip service using:
```bash
cd ../..
uv run python tools/data/import-trip-profiles.py
```

## Development

### Add More Destinations

Edit prompt in `generate_famous_destinations()` to request more locations or specific regions.

### Adjust Image Prompts

Modify `generate_gallery_prompts()` to change scene variety, distances, or styles.

### Change Image Size

Edit `generate_gallery_image()` resize dimensions (default: 512x512).
